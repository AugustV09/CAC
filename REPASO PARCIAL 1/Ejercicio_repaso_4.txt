    IMR EQU 21H
    PIO EQU 30H ; POSICION DEL REGISTRO PA DE LA PIO
    TIMER EQU 10H  ;POSICION DEL REGISTRO CONT DEL TIMER

    ORG 40
    DW  GESTOR_TIMER  ; DIREECION DEL GESTOR DEL TIMER
    
    ORG 3000H
LUCES12:
    PUSH BX
    MOV BX,SP
    PUSH AX
    PUSH DX
    ADD BX,4
    MOV BX,[BX]  ; SALO EN BX LA DIRECCION DEL ESTADO DE LAS LUCES
    MOV AL,[BX]  ;SALVO EN AL UNA COPIA DEL ESTADO DE LAS LUCES
    AND AL,128  ; MASCARA PARA SABER SI LA LUZ MAS SIGNIFICATIVA ESTA ENCENDIDA
    JZ FIN
    CLI  ; INHABILITO LAS INTERRUPCIONES
    MOV DL,1  ; FLAG PARA CONTROLAR EL TIMER
    MOV AL,11111101b    ;ENMASCARO TODO MENOS EL TIMER
    OUT IMR,AL
    MOV AL, 10  ; NUMERO DE VECTOR PARA EL GESTOR DEL TIMER
    OUT IMR+4,AL
    MOV AL,12  
    OUT TIMER+1,AL  ; GUARDO 12 EN EL REGISTRO COMP DEL TIMER
    MOV AL,0FFH
    OUT PIO+1,AL  ; ENCIENDO TODAS LAS LUCES
    MOV AL,0  
    OUT TIMER, AL  ; PONGO EN 0 EL REGISTRO CONT DEL TIMER
    STI  ; HABILITO LAS INTERRUPCIONES
ESPERAR:
    CMP DL,0
    JNZ ESPERAR
    MOV AL,0
    OUT PIO+1,AL  ; APAGO TODAS LAS LUCES
FIN:
    POP DX
    POP AX
    POP BX
    RET

GESTOR_TIMER:
    PUSH AX
    MOV DL,0
    IN AL,IMR
    AND AL,11111101b
    OUT IMR,AL
    MOV AL,20H
    OUT IMR-1,AL
    POP AX
    IRET

    ORG 1000H
LUCES DB ?

    ORG 2000H
    MOV AL,0FFH
    OUT PIO+2,AL  ; CONFIGURO PA COMO ENTRADA (CA = 11111111)
    MOV AL,0
    OUT PIO+3,AL  ; CONFIGURO PB COMO SALIDA (CB = 0)
    MOV BX,OFFSET LUCES
    IN AL, PIO
    MOV [BX],AL  ; GUARDO EL ESTADO DE LAS LUCES EN LA VARIABLE LUCES
    PUSH BX
    CALL LUCES12
    POP BX
    HLT
    END